#define ALARM_COOLDOWN 5000//报警
bool Alarmed = false;
bool Moving = false;
unsigned long lastAlarmTime = 0;

int IN1=7;
int IN2=6;
int ENA=10;
int IN3=5;
int IN4=4;
int ENB=11;//L298N驱动芯片引脚,A左B右

#include <SoftwareSerial.h>
int TX=8;
int RX=9;
SoftwareSerial BT(8, 9);
char cmd;
//HC-08蓝牙引脚

int ETL=2;//左超声波
int ETR=3;//右超声波
bool right=true;
bool left=false;
int detection_time=0;

int LED=A2;
int BZ=13;//报警

#include <MPU6050_tockn.h>
#include <Wire.h>
MPU6050 mpu6050(Wire);
#define SDA A4;
#define  SCL A5;
int INTM=12;//MPU-6050六轴姿态传感器模块  

int lefttime=0;
int righttime=0;
int rightduring=0;
int leftduring=0;
float leftdistance=0;
float rightdistance=0;//超声波相关参数


int speed=0;
int leftspeed=0;
int rightspeed=0;
int maxspeed=100; 
int minspeed=30; //电机相关参数
void Right()
{
 pinMode(3, OUTPUT);
  pinMode(2, INPUT);
  digitalWrite(3, LOW);
  delayMicroseconds(2);
  digitalWrite(3, HIGH);
  delayMicroseconds(10);
  digitalWrite(3, LOW);
   long t = pulseIn(2, HIGH);
   if(t<82352)
    {rightdistance = t * 0.017;
   detection_time=millis();
    }
right=false;
left=true;
}
void Left()
{
 pinMode(2, OUTPUT);
  pinMode(3, INPUT);
  digitalWrite(2, LOW);
  delayMicroseconds(2);
  digitalWrite(2, HIGH);
  delayMicroseconds(10);
  digitalWrite(2, LOW);
   long t = pulseIn(3, HIGH);
   if(t<5882)
   {leftdistance = t * 0.017;
    detection_time=millis();}
left=false;
right=true;
}

void MoveForward()
{
  digitalWrite(IN1,LOW);
digitalWrite(IN2,HIGH);
digitalWrite(IN3,LOW);
digitalWrite(IN4,HIGH);
analogWrite(ENA,255);
analogWrite(ENB,255);
}
void MoveLeft()
{
 digitalWrite(IN1,LOW);
digitalWrite(IN2,HIGH);
digitalWrite(IN3,LOW);
digitalWrite(IN4,HIGH);
analogWrite(ENA,255);
analogWrite(ENB,50);
}
void MoveRight()
{
 digitalWrite(IN1,LOW);
digitalWrite(IN2,HIGH);
digitalWrite(IN3,LOW);
digitalWrite(IN4,HIGH);
analogWrite(ENA,50);
analogWrite(ENB,255);
}
void MoveBack()
{
digitalWrite(IN1,HIGH);
digitalWrite(IN2,LOW);
digitalWrite(IN3,HIGH);
digitalWrite(IN4,LOW);
analogWrite(ENB,255);
analogWrite(ENA,255);
}
void MoveStop()
{
 digitalWrite(IN1,LOW);
digitalWrite(IN2,HIGH);
digitalWrite(IN3,LOW);
digitalWrite(IN4,HIGH);
analogWrite(ENA,0);
analogWrite(ENB,0);
}

void Motorcontrol()
{  if(cmd==1)
{ 
  if(leftdistance>20&&leftdistance>20)
  {
    MoveForward();
  }
  if(leftdistance<20&&leftdistance<20)
  {
   MoveStop();
  }
   
   if(leftdistance-rightdistance>10)
{
MoveRight();

}
if(rightdistance-leftdistance>10)
{
MoveLeft();

}
}
 else if(cmd==2)
{MoveStop();}
  else if(cmd==3)
{ MoveForward();}
 else if(cmd==4)
 {MoveRight();}
else if(cmd==5)
{MoveLeft();}
else if(cmd==6)
{MoveBack();}
else if(cmd==8)
{
MoveStop();
 Alert();
 
}

}
//电机驱动

void Alert()
{float accX = mpu6050.getAccX();
  float accY = mpu6050.getAccY();
  float accZ = mpu6050.getAccZ();
  float gyroX = mpu6050.getGyroX();
  float gyroY = mpu6050.getGyroY();
  float gyroZ = mpu6050.getGyroZ();
 float totalAcc = sqrt(accX*accX + accY*accY + accZ*accZ);
  // 计算合角速度（判断是否被转动/倾斜）
  float totalGyro = abs(gyroX) + abs(gyroY) + abs(gyroZ);
Serial.println("totalAcc");
Serial.println(totalAcc);
Serial.println("totalGyro");
Serial.println(totalGyro);
  // 判断是否触发报警
   Serial.println("Moving");
Serial.println(Moving);
 Serial.println("Alarmed");
Serial.println(Alarmed);
  if(totalAcc > 1.2 || totalGyro > 5)
  {Moving=true;
 
  }
  if (Moving && !Alarmed && (millis() - lastAlarmTime > ALARM_COOLDOWN)) 
  {
    // 触发报警
    sendAlarm();
    Alarmed = true;
    lastAlarmTime = millis();
    
    Moving=false;
  }
   else if (!Moving)
    {
    // 回到静止状态，重置报警标记
    Alarmed = false;
  }
}
void sendAlarm() {
  // 1. 蓝牙发送报警指令到手机
  BT.println("ALARM: 行李箱被移动！");
  // 2. 蜂鸣器报警（如果外接了蜂鸣器）
   for(int i=0;i<40;i++)
   {
   pinMode(BZ,OUTPUT);
   pinMode(LED,OUTPUT);
    digitalWrite(BZ, HIGH);
   digitalWrite(LED, HIGH);
   delay(100);
   digitalWrite(BZ, LOW);
 digitalWrite(LED, LOW);
  delay(100);
   }

}








void setup() {
  BT.begin(9600);
  Serial.begin(9600);//软串口通信
   
  Wire.begin();
  mpu6050.begin();
  mpu6050.calcGyroOffsets(true);//MPU-6050六轴姿态传感器模块  
 pinMode(4,OUTPUT);
pinMode(5,OUTPUT);
pinMode(IN3,OUTPUT);
pinMode(IN4,OUTPUT);
pinMode(ENA,OUTPUT);
pinMode(ENB,OUTPUT);//电机引脚模式设置

}

void loop() {
   
  // 打印结果
 
  if(millis()-detection_time>100)
  {if(right)
  {Right();
  
  }
  else if(left)
  {Left();
 
  }
  }
   Serial.print("右距离：");
  Serial.print(rightdistance);
  Serial.println(" cm");
    Serial.print("左距离：");
  Serial.print(leftdistance);
  Serial.println(" cm");
 
   if (BT.available() > 0) {
    cmd = BT.read();
    Serial.print("收到蓝牙指令：");
    Serial.println(cmd);

  }//软串口通信
 
mpu6050.update();
 Motorcontrol();
}
  
  
